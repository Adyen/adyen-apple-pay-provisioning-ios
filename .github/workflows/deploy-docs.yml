name: Deploy Docs ðŸš€

on:
  push:
    branches:
      - main

permissions:
  contents: write

concurrency:
  group: docs-deploy
  cancel-in-progress: false

jobs:
  Deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Read marketing version
        id: version
        run: |
          VER="$(cat version.txt)"
          echo "MARKETING_VERSION=$VER" >> "$GITHUB_ENV"

      - name: Stage docs into a single publish dir
        run: |
          set -euxo pipefail
          STAGE=".stage-docs"
          rm -rf "$STAGE"
          mkdir -p "$STAGE/${MARKETING_VERSION}/AdyenApplePayProvisioning"
          mkdir -p "$STAGE/${MARKETING_VERSION}/AdyenApplePayExtensionProvisioning"
          mkdir -p "$STAGE/${MARKETING_VERSION}/Api"

          cp -R ./AdyenApplePayProvisioning/Documentation/html/* \
                "$STAGE/${MARKETING_VERSION}/AdyenApplePayProvisioning/"
          cp -R ./AdyenApplePayExtensionProvisioning/Documentation/html/* \
                "$STAGE/${MARKETING_VERSION}/AdyenApplePayExtensionProvisioning/"
          cp -R ./ApiDocumentation/* \
                "$STAGE/${MARKETING_VERSION}/Api/"

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./.stage-docs
          keep_files: true
          force_orphan: false
          commit_message: |
            docs: publish ${MARKETING_VERSION}
            - AdyenApplePayProvisioning
            - AdyenApplePayExtensionProvisioning
            - API
